<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šç‰©æ–™åæŸ¥ç³»ç»Ÿ (V2.0 å¢å¼ºç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <style>
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f5f7fa; color: #333; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* é¡¶éƒ¨æ•°æ®åº“çŠ¶æ€æ ‡ç­¾ */
        .db-status { font-size: 14px; font-weight: normal; padding: 5px 10px; border-radius: 4px; background: #eee; color: #666; }
        .db-status.active { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }

        .section { margin-bottom: 25px; border-bottom: 1px dashed #eee; padding-bottom: 20px; }
        .section:last-child { border-bottom: none; }
        label { display: block; font-weight: bold; margin-bottom: 10px; color: #2c3e50; font-size: 1.1em; }
        
        .upload-box { border: 2px dashed #3498db; background-color: #f0f8ff; padding: 20px; text-align: center; border-radius: 5px; cursor: pointer; transition: 0.3s; margin-bottom: 15px; }
        .upload-box:hover { background-color: #e1f5fe; }
        input[type="file"] { display: none; }
        
        /* â˜…â˜…â˜… æ–°å¢ï¼šæ›´æ˜æ˜¾çš„æ–‡ä»¶åˆ—è¡¨æ ·å¼ â˜…â˜…â˜… */
        .file-list-container {
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .file-item:last-child { border-bottom: none; }
        .file-item:hover { background-color: #fff; }
        .file-name { font-weight: 500; color: #333; display: flex; align-items: center; }
        .file-name::before { content: "ğŸ“„"; margin-right: 8px; }
        .file-info { color: #888; font-size: 12px; }

        /* è¾“å…¥æ¡†å¸ƒå±€ */
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .input-field { flex: 1; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 15px; }
        input[type="text"]:focus { border-color: #3498db; outline: none; }
        
        /* æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 15px; }
        button { border: none; padding: 12px 25px; border-radius: 4px; cursor: pointer; font-size: 16px; transition: 0.3s; flex: 1; }
        
        .btn-primary { background-color: #3498db; color: white; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .btn-secondary { background-color: #95a5a6; color: white; }
        .btn-secondary:hover { background-color: #7f8c8d; }

        .btn-danger { background-color: #ff6b6b; color: white; flex: 0; white-space: nowrap; font-size: 13px; padding: 8px 15px; }
        .btn-danger:hover { background-color: #fa5252; }

        #status { margin-top: 10px; font-size: 14px; color: #666; display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; word-wrap: break-word; }
        th { background-color: #f8f9fa; color: #2c3e50; font-weight: 600; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        
        /* å¤åˆ¶æ ·å¼ */
        .copy-cell { cursor: pointer; position: relative; transition: background-color 0.2s; }
        .copy-cell:hover { background-color: #e3f2fd !important; color: #1976d2; font-weight: bold; }
        .copy-cell:hover::after {
            content: "ç‚¹å‡»å¤åˆ¶"; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 11px;
            background: #1976d2; color: white; padding: 2px 6px; border-radius: 3px; pointer-events: none;
        }
        .copy-cell:active { background-color: #bbdefb !important; }

        th:nth-child(1) { width: 20%; }
        th:nth-child(2) { width: 20%; }
        th:nth-child(3) { width: 40%; }
        th:nth-child(4) { width: 20%; }

        .highlight { background-color: #fff3cd; color: #856404; font-weight: bold; }

        #toast {
            visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center;
            border-radius: 4px; padding: 12px; position: fixed; z-index: 1000; left: 50%; bottom: 40px;
            transform: translateX(-50%); font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 60px; }
    </style>
</head>
<body>

<div class="container">
    <h1>
        ğŸ” ä¼ä¸šç‰©æ–™åæŸ¥ç³»ç»Ÿ
        <span id="dbIndicator" class="db-status">æ•°æ®åº“æœªè¿æ¥</span>
    </h1>
    
    <div class="section">
        <label>1. æ•°æ®åº“ç®¡ç† (è‡ªåŠ¨è®°å¿†)</label>
        
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <div style="font-size: 24px; margin-bottom: 5px;">ğŸ“‚</div>
            <span id="fileLabel">ç‚¹å‡»ä¸Šä¼  Excel/CSV æ–‡ä»¶ (æ”¯æŒè¿½åŠ ä¸Šä¼ )</span>
            <input type="file" id="fileInput" multiple accept=".xls,.xlsx,.csv" onchange="handleFiles(this.files)">
        </div>
        
        <label style="font-size: 14px; color: #666; margin-top: 15px;">ğŸ“š å·²å½’æ¡£æ–‡ä»¶åˆ—è¡¨ï¼š</label>
        <div class="file-list-container" id="fileListContainer">
            <div style="padding:10px; color:#999; text-align:center;">æš‚æ— æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ ...</div>
        </div>

        <div id="status">
            <span id="statusText">æ­£åœ¨æ£€æŸ¥æœ¬åœ°ç¼“å­˜...</span>
            <button class="btn-danger" onclick="clearDatabase()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>
    </div>

    <div class="section">
        <label>2. è¾“å…¥æŸ¥è¯¢æ¡ä»¶</label>
        <div class="input-group">
            <div class="input-field"><input type="text" id="pnInput" placeholder="è¾“å…¥å“å·"></div>
            <div class="input-field"><input type="text" id="nameInput" placeholder="è¾“å…¥å“å"></div>
            <div class="input-field"><input type="text" id="specInput" placeholder="è¾“å…¥è§„æ ¼"></div>
        </div>
        
        <div class="btn-group">
            <button id="searchBtn" class="btn-primary" onclick="searchData()" disabled>å¼€å§‹æŸ¥è¯¢</button>
            <button id="clearBtn" class="btn-secondary" onclick="clearInputs()">æ¸…ç©ºæ¡ä»¶</button>
        </div>
    </div>

    <div class="section" style="border-bottom:none;">
        <div id="resultArea"></div>
    </div>
</div>

<div id="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

<script>
    const DB_KEY = 'material_db_v2'; // å‡çº§Keyï¼Œç¡®ä¿æ•°æ®ç»“æ„æœ€æ–°
    const FILES_KEY = 'material_files_v2';
    
    let globalDB = []; // å†…å­˜ä¸­çš„æ•°æ®
    let loadedFiles = []; // å†…å­˜ä¸­çš„æ–‡ä»¶åˆ—è¡¨ [{name: 'xx.xls', count: 100}]

    document.addEventListener('DOMContentLoaded', async function() {
        await loadFromCache();
    });

    // --- 1. ç¼“å­˜åŠ è½½é€»è¾‘ ---
    async function loadFromCache() {
        try {
            const dbData = await localforage.getItem(DB_KEY);
            const filesData = await localforage.getItem(FILES_KEY);

            if (dbData && dbData.length > 0) {
                globalDB = dbData;
                loadedFiles = filesData || [];
                
                updateUIState(true, `âœ… è®°å¿†åº“å·²å°±ç»ªï¼Œå…± ${globalDB.length} æ¡æ•°æ®`);
                renderFileList(); // å…³é”®ï¼šåŠ è½½åç«‹åˆ»æ¸²æŸ“åˆ—è¡¨
                document.getElementById('searchBtn').disabled = false;
            } else {
                updateUIState(false, "æš‚æ— æœ¬åœ°æ•°æ®ï¼Œè¯·ä¸Šä¼ æ–‡ä»¶");
                renderFileList();
            }
        } catch (err) {
            console.error("è¯»å–ç¼“å­˜å¤±è´¥", err);
            updateUIState(false, "è¯»å–è®°å¿†å¤±è´¥");
        }
    }

    async function saveToCache() {
        try {
            await localforage.setItem(DB_KEY, globalDB);
            await localforage.setItem(FILES_KEY, loadedFiles);
        } catch (err) {
            alert("å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå¯èƒ½æ— æ³•è®°ä½æœ¬æ¬¡ä¸Šä¼ çš„æ•°æ®ã€‚");
        }
    }

    async function clearDatabase() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å’Œæ–‡ä»¶è®°å½•å—ï¼Ÿ")) {
            await localforage.clear();
            globalDB = [];
            loadedFiles = [];
            renderFileList();
            document.getElementById('resultArea').innerHTML = "";
            updateUIState(false, "è®°å¿†å·²æ¸…ç©º");
            document.getElementById('searchBtn').disabled = true;
        }
    }

    function updateUIState(hasData, msg) {
        const indicator = document.getElementById('dbIndicator');
        const statusText = document.getElementById('statusText');
        statusText.innerText = msg;
        if (hasData) {
            indicator.innerText = "ğŸŸ¢ å·²è¿æ¥è®°å¿†åº“";
            indicator.className = "db-status active";
            statusText.style.color = "green";
        } else {
            indicator.innerText = "âšª ç©ºé—²ä¸­";
            indicator.className = "db-status";
            statusText.style.color = "#666";
        }
    }

    // --- 2. æ ¸å¿ƒï¼šæ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ ---
    function renderFileList() {
        const container = document.getElementById('fileListContainer');
        container.innerHTML = ""; // æ¸…ç©ºå½“å‰æ˜¾ç¤º
        
        if (loadedFiles.length === 0) {
            container.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">æš‚æ— æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ ...</div>';
            return;
        }

        // éå†å¹¶åœ¨ç•Œé¢ä¸Šåˆ›å»ºæ¯ä¸€è¡Œ
        loadedFiles.forEach(file => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "file-item";
            
            // å·¦ä¾§ï¼šæ–‡ä»¶å
            const nameSpan = document.createElement("span");
            nameSpan.className = "file-name";
            nameSpan.innerText = file.name;
            
            // å³ä¾§ï¼šæ•°æ®é‡ä¿¡æ¯
            const infoSpan = document.createElement("span");
            infoSpan.className = "file-info";
            infoSpan.innerText = `å« ${file.count} æ¡æ•°æ®`;
            
            itemDiv.appendChild(nameSpan);
            itemDiv.appendChild(infoSpan);
            container.appendChild(itemDiv);
        });
    }

    // --- 3. æ–‡ä»¶å¤„ç† (å¸¦ç»Ÿè®¡åŠŸèƒ½) ---
    async function handleFiles(files) {
        if (files.length === 0) return;
        
        document.getElementById('statusText').innerText = `æ­£åœ¨å¤„ç† ${files.length} ä¸ªæ–°æ–‡ä»¶...`;
        document.getElementById('statusText').style.color = "#e67e22";
        document.getElementById('searchBtn').disabled = true;

        const promises = Array.from(files).map(file => readFile(file));
        
        try {
            const results = await Promise.all(promises);
            // results ç»“æ„: [{fileName: 'a.xls', items: [...]}, {fileName: 'b.xls', items: [...]}]
            
            let addedCount = 0;

            results.forEach(res => {
                if (res.items.length > 0) {
                    // 1. è¿½åŠ æ•°æ®
                    globalDB = globalDB.concat(res.items);
                    addedCount += res.items.length;

                    // 2. æ›´æ–°æ–‡ä»¶åˆ—è¡¨ (å…ˆåˆ æ—§çš„åŒåè®°å½•ï¼Œå†åŠ æ–°çš„)
                    loadedFiles = loadedFiles.filter(f => f.name !== res.fileName);
                    loadedFiles.push({
                        name: res.fileName,
                        count: res.items.length
                    });
                }
            });

            if (addedCount > 0) {
                // 3. æ•°æ®å»é‡
                const uniqueMap = new Map();
                globalDB.forEach(item => uniqueMap.set(item.pn, item));
                globalDB = Array.from(uniqueMap.values());

                // 4. ä¿å­˜å¹¶åˆ·æ–°ç•Œé¢
                await saveToCache();
                renderFileList(); // æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
                updateUIState(true, `âœ… æˆåŠŸè¿½åŠ  ${addedCount} æ¡æ•°æ®ï¼å½“å‰æ€»è®¡ ${globalDB.length} æ¡`);
                document.getElementById('searchBtn').disabled = false;
            } else {
                document.getElementById('statusText').innerText = "âš ï¸ æœªæå–åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼";
            }
        } catch (err) {
            console.error(err);
            document.getElementById('statusText').innerText = "âŒ è§£æå‡ºé”™";
        }
        document.getElementById('fileInput').value = ''; // é‡ç½® input
    }

    function readFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    let allItems = [];
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        const items = extractBlockData(file.name, jsonData);
                        allItems = allItems.concat(items);
                    });
                    // è¿”å›æ–‡ä»¶åå’Œå¯¹åº”çš„æ•°æ®
                    resolve({ fileName: file.name, items: allItems });
                } catch (err) {
                    reject(err);
                }
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    function extractBlockData(fileName, rows) {
        let extracted = [];
        let currentPN = null;
        let currentName = ""; 
        rows.forEach(row => {
            row.forEach((cell, colIndex) => {
                if (!cell) return;
                let val = String(cell).trim().replace(/\s/g, ""); 
                if (val.includes("å“å·") && (val.includes(":") || val.includes("ï¼š"))) {
                    if (colIndex + 1 < row.length) {
                        let potentialPN = String(row[colIndex + 1]).trim();
                        if (potentialPN && !potentialPN.includes("~") && potentialPN !== "undefined") {
                            currentPN = potentialPN; currentName = ""; 
                        }
                    }
                }
                if (currentPN) {
                   if (val.includes("å“å") && (val.includes(":") || val.includes("ï¼š"))) {
                        if (colIndex + 1 < row.length) {
                            let potentialName = String(row[colIndex + 1]).trim();
                            if (potentialName && potentialName !== "undefined") {
                                currentName = potentialName;
                            }
                        }
                    }
                }
                if (currentPN) {
                    if (val.includes("è§„æ ¼") && (val.includes(":") || val.includes("ï¼š"))) {
                        if (colIndex + 1 < row.length) {
                            let specVal = String(row[colIndex + 1]).trim();
                            if (specVal && specVal !== "undefined") {
                                extracted.push({
                                    file: fileName,
                                    pn: currentPN,
                                    name: currentName, 
                                    spec: specVal
                                });
                            }
                        }
                    }
                }
            });
        });
        return extracted;
    }

    // --- 4. æœç´¢ä¸å¤åˆ¶ (ä¿æŒä¸å˜) ---
    function searchData() {
        const pnQuery = document.getElementById('pnInput').value.toLowerCase().trim();
        const nameQuery = document.getElementById('nameInput').value.toLowerCase().trim(); 
        const specQuery = document.getElementById('specInput').value.toLowerCase().trim();
        const resultDiv = document.getElementById('resultArea');

        if (!pnQuery && !specQuery && !nameQuery) {
            alert("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶ï¼");
            return;
        }

        const results = globalDB.filter(item => {
            const matchPN = pnQuery ? String(item.pn).toLowerCase().includes(pnQuery) : true;
            const matchName = nameQuery ? String(item.name).toLowerCase().includes(nameQuery) : true;
            const matchSpec = specQuery ? String(item.spec).toLowerCase().includes(specQuery) : true;
            return matchPN && matchName && matchSpec;
        });

        if (results.length === 0) {
            resultDiv.innerHTML = '<p style="color:red; text-align:center;">âŒ æœªæ‰¾åˆ°åŒ¹é…è®°å½•</p>';
            return;
        }

        let html = `<h3>âœ… æ‰¾åˆ° ${results.length} æ¡è®°å½•ï¼š</h3>`;
        html += `<table><thead><tr><th>å“å·</th><th>å“å</th><th>è§„æ ¼</th><th>æ¥æºæ–‡ä»¶</th></tr></thead><tbody>`;
        
        results.forEach(item => {
            html += `<tr>
                <td class="copy-cell ${pnQuery && String(item.pn).toLowerCase().includes(pnQuery) ? 'highlight' : ''}" 
                    onclick="handleCopy(this)">${item.pn}</td>
                <td class="copy-cell ${nameQuery && String(item.name).toLowerCase().includes(nameQuery) ? 'highlight' : ''}" 
                    onclick="handleCopy(this)">${item.name}</td>
                <td class="copy-cell ${specQuery && String(item.spec).toLowerCase().includes(specQuery) ? 'highlight' : ''}" 
                    onclick="handleCopy(this)">${item.spec}</td>
                <td>${item.file}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
        resultDiv.innerHTML = html;
    }

    function clearInputs() {
        document.getElementById('pnInput').value = '';
        document.getElementById('nameInput').value = '';
        document.getElementById('specInput').value = '';
        document.getElementById('resultArea').innerHTML = ''; 
    }

    function handleCopy(element) {
        const text = element.innerText;
        if (!text) return;
        copyToClipboard(text);
    }

    function copyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0";
        document.body.appendChild(textArea);
        textArea.focus(); textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) showToast("âœ… å·²å¤åˆ¶: " + text);
            else useNavigatorClipboard(text);
        } catch (err) {
            useNavigatorClipboard(text);
        }
        document.body.removeChild(textArea);
    }

    function useNavigatorClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text)
                .then(() => showToast("âœ… å·²å¤åˆ¶: " + text))
                .catch(() => alert("å¤åˆ¶å¤±è´¥"));
        } else alert("å¤åˆ¶å¤±è´¥");
    }

    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.innerText = msg;
        toast.className = "show";
        if (window.toastTimeout) clearTimeout(window.toastTimeout);
        window.toastTimeout = setTimeout(() => { 
            toast.className = toast.className.replace("show", ""); 
        }, 2000);
    }
</script>

</body>
</html>
